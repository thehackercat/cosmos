# 03-黑盒之中有什么：内核结构与设计

December 2, 2021 2021-12-02

### 经典内核结构

**宏内核结构**

宏内核就是把以上诸如管理进程的代码、管理内存的代码、管理各种 I/O 设备的代码、文件系统的代码、图形系统代码以及其它功能模块的代码，把这些所有的代码经过编译，最后链接在一起，形成一个大的可执行程序。

宏内核工作原理:

1. 应用程序调用内存分配的 API（应用程序接口）函数。

2. 处理器切换到特权模式，开始运行内核代码。

3. 内核里的内存管理代码按照特定的算法，分配一块内存。

4. 把分配的内存块的首地址，返回给内存分配的 API 函数。

5. 内存分配的 API 函数返回，处理器开始运行用户模式下的应用程序，应用程序就得到了一块内存的首地址，并且可以使用这块内存了。

宏内核结构优点:

宏内核唯一的优点是性能很好，因为在内核中，这些组件可以互相调用，性能极高。

宏内核结构缺点:

没有模块化，没有扩展性、没有移植性，高度耦合在一起，一旦其中一个组件有漏洞，内核中所有的组件可能都会出问题。

**微内核结构**

微内核架构正好与宏内核架构相反，它提倡内核功能尽可能少：仅仅只有进程调度、处理中断、内存空间映射、进程间通信等功能（目前不懂没事，这是属于管理进程和管理内存的功能模块，后面课程里还会专门探讨的）。

宏内核工作原理:

1. 应用程序发送内存分配的消息，这个发送消息的函数是微内核提供的，相当于系统 API，微内核的 API（应用程序接口）相当少，极端情况下仅需要两个，一个接收消息的 API 和一个发送消息的 API。

2. 处理器切换到特权模式，开始运行内核代码。

3. 微内核代码让当前进程停止运行，并根据消息包中的数据，确定消息发送给谁，分配内存的消息当然是发送给内存管理服务进程。

4. 内存管理服务进程收到消息，分配一块内存。

5. 内存管理服务进程，也会通过消息的形式返回分配内存块的地址给内核，然后继续等待下一条消息。

6. 微内核把包含内存块地址的消息返回给发送内存分配消息的应用程序。

7. 处理器开始运行用户模式下的应用程序，应用程序就得到了一块内存的首地址，并且可以使用这块内存了。

微内核结构优点:

首先，系统结构相当清晰利于协作开发。其次，系统有良好的移植性，微内核代码量非常少，就算重写整个内核也不是难事。最后，微内核有相当好的伸缩性、扩展性，因为那些系统功能只是一个进程，可以随时拿掉一个服务进程以减少系统功能，或者增加几个服务进程以增强系统功能。

微内核结构缺点:

性能差。

![内核分层结构图](03-%E9%BB%91%E7%9B%92%E4%B9%8B%E4%B8%AD%E6%9C%89%E4%BB%80%E4%B9%88%EF%BC%9A%E5%86%85%E6%A0%B8%E7%BB%93%E6%9E%84%E4%B8%8E%E8%AE%BE%E8%AE%A1%204cc86392958545d89372de19dff96d44/Untitled.png)

内核分层结构图